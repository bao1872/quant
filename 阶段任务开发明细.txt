ä¸€ã€ç›®æ ‡ï¼šæŠŠç‰¹å¾æ‰©å±•æˆã€Œè¿ç»­ 3 ä¸ªäº¤æ˜“æ—¥ã€

å¯¹äºæ¯ä¸ªæ ·æœ¬ï¼ˆæ± å­é‡Œçš„ ts_code, trade_dateï¼‰ï¼š

ä¸å†åªç”¨ å½“å¤© çš„ç‰¹å¾ï¼Œ

è€Œæ˜¯æŠŠ tã€t-1ã€t-2 ä¸‰å¤©çš„å…³é”®ä¿¡æ¯ä¸€èµ·ä½œä¸ºè¾“å…¥ã€‚

å…·ä½“åšæ³•ï¼š

é€‰å‡ºä¸€æ‰¹â€œåŸºç¡€ç‰¹å¾â€ï¼ˆå½“æ—¥ Bollinger + å½“æ—¥ tick èšåˆï¼‰ï¼›

å¯¹æ¯ä¸ªåŸºç¡€ç‰¹å¾ï¼Œæ„é€ ï¼š

col_lag1ï¼šå‰ 1 ä¸ªäº¤æ˜“æ—¥çš„å€¼ï¼ˆt-1ï¼‰

col_lag2ï¼šå‰ 2 ä¸ªäº¤æ˜“æ—¥çš„å€¼ï¼ˆt-2ï¼‰

ï¼ˆå¯é€‰ï¼‰col_mean3ï¼šæœ€è¿‘ 3 æ—¥å‡å€¼

åœ¨è®­ç»ƒæ•°æ®æ„å»ºé˜¶æ®µç»Ÿä¸€å¢åŠ è¿™äº›åˆ—ï¼Œæ¨¡å‹è®­ç»ƒç›´æ¥ä½¿ç”¨ã€‚

æ³¨æ„ï¼š

åªç”¨ shift å‘åçœ‹ï¼Œä¸ä¼šæœ‰æœªæ¥ä¿¡æ¯æ³„éœ²ï¼›

æœ€å‰é¢ä¸¤å¤©çš„æ ·æœ¬ä¼šæœ‰ NaNï¼Œæˆ‘ä»¬ç”¨ä½ ç°æœ‰çš„ clean_features åš clip+å¡«å……å³å¯ã€‚

äºŒã€å¼€å‘æ­¥éª¤æ€»è§ˆ

åœ¨ ml/pool_data_loader.py é‡Œæ–°å¢ï¼š

ä¸€ä¸ªé…ç½®ï¼šLAG_BASE_FEATURESï¼ˆä½ å¸Œæœ›åš 3 æ—¥æ‰©å±•çš„åŸºç¡€åˆ—åï¼‰

ä¸€ä¸ªå‡½æ•°ï¼šadd_3day_features(df, lag_base_features, n_lags=2, use_mean3=True)

åœ¨æ„å»ºè®­ç»ƒæ•°æ®çš„æµç¨‹é‡Œï¼š

åœ¨ load_pool_merged_dataset(...) æœ€åä¸€æ­¥ã€è¿”å›å‰ï¼Œè°ƒç”¨ add_3day_featuresï¼›

å†é‡æ–°è®¡ç®— feature_colsï¼ˆåŒ…å«æ–°åŠ çš„ lag ç‰¹å¾ï¼‰ã€‚

train_xgb_from_pool.py æ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘ï¼Œåªæ˜¯è‡ªåŠ¨å¤šäº†ç‰¹å¾ã€‚

ä»¥ååšæ—¥å¸¸é¢„æµ‹ï¼ˆdaily_predictï¼‰æ—¶ï¼ŒåŒæ ·è°ƒç”¨ add_3day_featuresï¼Œåªå–é¢„æµ‹æ—¥é‚£ä¸€è¡Œå³å¯ã€‚

ä¸‹é¢ç»™ä½ å¯ä»¥ç›´æ¥ç”¨çš„æ ¸å¿ƒä»£ç ã€‚

ä¸‰ã€åœ¨ pool_data_loader é‡Œå¢åŠ  3 æ—¥ç‰¹å¾
1ï¼‰é€‰æ‹©åŸºç¡€ç‰¹å¾åˆ—è¡¨

åœ¨ ml/pool_data_loader.py é¡¶éƒ¨ï¼ˆimport ä¸‹é¢ï¼‰åŠ ä¸€æ®µé…ç½®ï¼š

# è¿™äº›æ˜¯ä½ â€œå¸Œæœ›æ‰©å±•åˆ° 3 æ—¥â€çš„åŸºç¡€ç‰¹å¾åˆ—å
# åå­—è¦å’Œ stock_bollinger_data / stock_tick_daily_features é‡Œçš„åˆ—ä¸€è‡´
LAG_BASE_FEATURES = [
    # --- Bollinger ç›¸å…³ ---
    "price_position",
    "v_price_position",
    "band_width_zscore",
    "v_band_width_zscore",
    # å¦‚æœè¿˜æœ‰å…¶å®ƒä½ å¾ˆçœ‹é‡çš„å¸ƒæ—ç‰¹å¾ï¼Œä¹Ÿå¯ä»¥åŠ è¿›æ¥
    # "price_position_ma5",
    # "band_width_zscore_ma5",

    # --- Tick æ—¥å†…èšåˆç›¸å…³ï¼ˆæ ¹æ®ä½ çš„è¡¨å­—æ®µæ¥å¡«ï¼‰ ---
    # æ¯”å¦‚ï¼š
    "vwap",
    "active_buy_vol_ratio",
    "amount_sum",
    "volume_sum",
    # ...
]


ä½ å¯ä»¥å…ˆåªæ”¾ 4 ä¸ªå¸ƒæ— + 2~4 ä¸ª tick ç‰¹å¾ï¼Œè·‘é€šä¹‹åå†æ…¢æ…¢åŠ ã€‚

2ï¼‰æ–°å¢å‡½æ•°ï¼šadd_3day_features

æ”¾åœ¨ ml/pool_data_loader.py é‡Œï¼ˆå’Œ clean_features åŒä¸€å±‚çº§ï¼‰ï¼š

def add_3day_features(
    df: pd.DataFrame,
    lag_base_features: List[str],
    n_lags: int = 2,
    use_mean3: bool = True,
) -> pd.DataFrame:
    """
    åœ¨ df ä¸Šå¢åŠ â€œè¿ç»­3ä¸ªäº¤æ˜“æ—¥â€çš„ç‰¹å¾ï¼š
      - å¯¹ lag_base_features ä¸­çš„æ¯ä¸ªç‰¹å¾ colï¼š
          col_lag1 = t-1
          col_lag2 = t-2
          (å¯é€‰) col_mean3 = æœ€è¿‘3æ—¥çª—å£å‡å€¼

    è¦æ±‚ df è‡³å°‘åŒ…å«åˆ—ï¼š
      - ts_code
      - trade_date
      - lag_base_features ä¸­çš„åˆ—ï¼ˆæœ‰ç¼ºå¤±çš„ä¼šè·³è¿‡ï¼‰
    """
    df = df.sort_values(["ts_code", "trade_date"]).copy()

    # ç¡®ä¿ trade_date æ˜¯æ—¥æœŸç±»å‹ï¼Œåé¢ä¸åšè¿ç®—ï¼Œåªç”¨äºæ’åº
    # å¦‚æœå‰é¢å·²ç»è½¬è¿‡å¯ä»¥ç•¥è¿‡è¿™ä¸€æ­¥
    # df["trade_date"] = pd.to_datetime(df["trade_date"]).dt.date

    grouped = df.groupby("ts_code")

    for col in lag_base_features:
        if col not in df.columns:
            # æŸäº›ç‰¹å¾æœ¬æ¥å°±æ²¡æœ‰ï¼Œæ¯”å¦‚ tick è¡¨ç¼ºå°‘æŸåˆ—ï¼Œç›´æ¥è·³è¿‡
            continue

        # lag 1, lag 2 ...
        for lag in range(1, n_lags + 1):
            new_col = f"{col}_lag{lag}"
            df[new_col] = grouped[col].shift(lag)

        if use_mean3:
            # æœ€è¿‘3æ—¥æ»šåŠ¨å‡å€¼
            new_col_mean = f"{col}_mean3"
            df[new_col_mean] = (
                grouped[col]
                .rolling(window=3, min_periods=1)
                .mean()
                .reset_index(level=0, drop=True)
            )

    return df

3ï¼‰åœ¨ load_pool_merged_dataset é‡Œè°ƒç”¨

å‡è®¾ä½ ç°åœ¨çš„ load_pool_merged_dataset å¤§è‡´æ˜¯è¿™æ ·çš„ï¼ˆä½ å·²ç»æ”¹æˆäº†åˆ† chunk + concat çš„ç‰ˆæœ¬ï¼Œæˆ‘ç›´æ¥ç»™â€œæœ€ç»ˆæ‹¼å®Œ df åâ€çš„å¤„ç†é€»è¾‘ï¼‰ï¼š

def load_pool_merged_dataset(
    engine: Engine,
    dr: PoolDataRangeConfig,
) -> Tuple[pd.DataFrame, List[str], str]:
    """
    ä» stock_pool_ml_samples å‡ºå‘ï¼Œjoin ä¸Š:
      - stock_bollinger_data
      - stock_tick_daily_features
    + å¢åŠ è¿ç»­3æ—¥ç‰¹å¾
    è¿”å›: df, feature_cols, label_col
    """
    # è¿™é‡Œå‡è®¾ä½ å·²ç»æœ‰ä¸€ä¸ªæŒ‰ chunk è¯»å–çš„æµç¨‹ï¼Œ
    # æœ€ç»ˆå¾—åˆ°äº†ä¸€ä¸ª concat å®Œæ•´çš„ df_allï¼š
    #   df_all = pd.concat(frames, ignore_index=True)
    #   df_all["trade_date"] = df_all["trade_date"].dt.date
    # æˆ‘ç›´æ¥ä» df_all å¼€å§‹å†™ï¼š

    # ---- è¿™æ˜¯ä¼ªä»£ç ï¼Œæ›¿æ¢æˆä½ ç°åœ¨å®é™…çš„ concat é€»è¾‘ ----
    df_all = ...  # ä½ ç°æœ‰çš„ concat åçš„ DataFrame

    # å»æ‰é‡å¤åˆ—åï¼ˆå¦‚æœ s/b/t æœ‰é‡å¤å­—æ®µï¼‰
    df_all = df_all.loc[:, ~df_all.columns.duplicated()]

    # å…ˆå¢åŠ  3 æ—¥ç‰¹å¾
    df_all = add_3day_features(df_all, LAG_BASE_FEATURES, n_lags=2, use_mean3=True)

    # åªä¿ç•™æ•°å€¼åˆ—
    numeric_cols = df_all.select_dtypes(include=[np.number]).columns.tolist()
    label_col = dr.label_col

    if label_col not in numeric_cols:
        raise RuntimeError(f"Label column {label_col} not in numeric columns.")

    # ç‰¹å¾åˆ— = æ•°å€¼åˆ— - æ ‡ç­¾
    feature_cols = [c for c in numeric_cols if c != label_col]

    return df_all, feature_cols, label_col


ä½ å®é™…é¡¹ç›®é‡Œå·²ç»æœ‰æ‰“å°æ—¥å¿—ã€æŒ‰ chunk è¯»å–çš„å®ç°ï¼Œåªéœ€è¦åœ¨ concat å®Œçš„åœ°æ–¹æ’è¿™ä¸€å¥ï¼š

df_all = add_3day_features(df_all, LAG_BASE_FEATURES, n_lags=2, use_mean3=True)


ç„¶åå† select_dtypes é€‰ç‰¹å¾åˆ—å³å¯ã€‚

å››ã€è®­ç»ƒè„šæœ¬ä¸éœ€è¦æ”¹é€»è¾‘

ml/train_xgb_from_pool.py é‡Œï¼š

df, feature_cols, label_col = load_pool_merged_dataset(engine, data_range)
df = clean_features(df, feature_cols)
...


è¿™ä¸€æ®µä¸ç”¨å˜ï¼š

load_pool_merged_dataset å·²ç»å¸®ä½ æŠŠ 3 æ—¥ç‰¹å¾åŠ è¿›æ¥äº†ï¼›

feature_cols åŒ…å«äº†åŸæ¥çš„å•æ—¥+ lag1+lag2+mean3 åˆ—ï¼›

clean_features ä¼šç»Ÿä¸€å¯¹æ‰€æœ‰æ•°å€¼åˆ—åš clip + å¡«å……ã€‚

ä½ åªä¼šçœ‹åˆ°ï¼š

æ—¥å¿—é‡Œçš„ features= æ•°é‡å˜å¤šï¼›

è®­ç»ƒæ—¶é—´ç¨å¾®é•¿ä¸€ç‚¹ï¼›

IC / åˆ†ç»„æ”¶ç›Šå¯èƒ½æœ‰å˜åŒ–ï¼ˆæˆ‘ä»¬å¸Œæœ›æœ‰æå‡ ğŸ˜‚ï¼‰ã€‚

äº”ã€é¢„æµ‹æ—¶è¦è®°å¾—ä¹Ÿç”¨ 3 æ—¥ç‰¹å¾ï¼ˆæç¤ºä¸€ä¸‹ï¼‰

è™½ç„¶ä½ è¿™ä¸€æ­¥å…ˆä¸“æ³¨è®­ç»ƒï¼Œä½†ä¸ºäº†ä»¥åä¸è¸©å‘ï¼Œæˆ‘æå‰æé†’ä¸€ä¸‹ï¼š

æœªæ¥ä½ åœ¨ daily_predict.py é‡Œåšé¢„æµ‹æ—¶ï¼Œä¸èƒ½åªæŸ¥å•ä¸ªäº¤æ˜“æ—¥ t å†ç›´æ¥åŠ  lag åˆ—ï¼›

éœ€è¦ä¸€æ¬¡æ‹‰ [t-2, t] è¿™ä¸‰å¤©çš„ç‰¹å¾ï¼Œè°ƒç”¨ add_3day_featuresï¼Œå†ä»ä¸­ç­›å‡º trade_date == t çš„é‚£è¡Œæ¥é¢„æµ‹ã€‚

ä¼ªä»£ç ç¤ºä¾‹ï¼ˆä»¥åä½ è¦åšé¢„æµ‹æ—¶å¯ä»¥ç…§è¿™ä¸ªæ”¹ï¼‰ï¼š

def load_features_for_date_with_lags(engine, trade_date, feature_cols):
    start = trade_date - dt.timedelta(days=10)  # ç”¨10å¤©è¦†ç›–ï¼Œé‡Œé¢å®é™…åªæœ‰3ä¸ªäº¤æ˜“æ—¥
    end = trade_date

    # ä» boll+ticks+pool é‡ŒæŠŠè¿™æ®µæ—¥æœŸçš„æ ·æœ¬æ‹‰å‡ºæ¥ï¼ˆç±»ä¼¼è®­ç»ƒæ—¶çš„ joinï¼Œä½†åªåšè¿™å‡ å¤©ï¼‰
    df = ...  # join å‡º [start, end] åŒºé—´çš„æ ·æœ¬

    df = add_3day_features(df, LAG_BASE_FEATURES, n_lags=2, use_mean3=True)

    # åªä¿ç•™é¢„æµ‹æ—¥
    df_today = df[df["trade_date"] == trade_date].copy()

    X = df_today[feature_cols].to_numpy(dtype=float)
    return df_today, X


è®­ç»ƒå’Œé¢„æµ‹ç”¨åŒä¸€ä¸ª add_3day_features å‡½æ•° + åŒä¸€æ‰¹ feature_colsï¼Œå°±ä¸ä¼šå‡ºç°ç‰¹å¾é”™ä½é—®é¢˜ã€‚

å…­ã€ä½ æ¥ä¸‹æ¥å¯ä»¥æŒ‰è¿™ä¸ªé¡ºåºæ¥

åœ¨ pool_data_loader.py é‡ŒåŠ ï¼š

LAG_BASE_FEATURES åˆ—è¡¨ï¼›

add_3day_features å‡½æ•°ï¼›

åœ¨æ‹¼å®Œ df_all çš„åœ°æ–¹è°ƒç”¨ add_3day_featuresï¼Œç„¶åé‡æ–°é€‰ feature_colsï¼›

é‡æ–°è·‘ä¸€é python -m ml.train_xgb_from_poolï¼š

çœ‹æ—¥å¿—é‡Œçš„ features= æ˜¯å¦å˜å¤šï¼›

çœ‹æ–°çš„ IC & åˆ†ç»„æ”¶ç›Šæœ‰æ²¡æœ‰å˜åŒ–ï¼ˆå¯èƒ½ IC ä¼šå†æ¶¨ä¸€ç‚¹ï¼Œæˆ–è€… Q5/Q4 æ›´æ¼‚äº®ï¼‰ï¼›