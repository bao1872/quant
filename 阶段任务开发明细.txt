è€ƒè™‘å¼•å…¥ä¸€ä¸ªè½»é‡ Settings å¯¹è±¡

ä¸ä¸€å®šè¦ä¸Š pydanticï¼Œç®€å•ä¸€ç‚¹ä¹Ÿè¡Œï¼Œä¾‹å¦‚ï¼š

from dataclasses import dataclass

@dataclass
class Settings:
    database_url: str = DATABASE_URL
    tick_base_dir: str = str(TICK_BASE_DIR)
    stock_pool_limit: int | None = STOCK_POOL_LIMIT
    tick_count_limit: int = TICK_COUNT_LIMIT


è¿™æ ·åœ¨ updater / repository / tick_store é‡Œå¯ä»¥æ¥å—ä¸€ä¸ª settings: Settingsï¼Œæ–¹ä¾¿ä»¥ååšå•å…ƒæµ‹è¯•å’Œä¸åŒç¯å¢ƒæ³¨å…¥ã€‚

Dummy + Real DB è¡Œä¸ºç»Ÿä¸€

ç°åœ¨ DummySession çš„æ¥å£å¾ˆå¥½ï¼ˆquery/merge/add/bulk_save_objects/commit éƒ½æœ‰ï¼‰ï¼Œä½†åœ¨çœŸå® DB æ¨¡å¼é‡Œä½ æœ‰ä¸¤å¥—å†™æ³•ï¼š

ä¸€å¥—æ˜¯ session.bulk_save_objects(objs)ï¼ˆä½† StockDaily/Minute å¹¶ä¸æ˜¯ SQLAlchemy æ˜ å°„ç±»ï¼‰ã€‚

ä¸€å¥—æ˜¯ pandas to_sql + åŸç”Ÿ SQL è¯­å¥ã€‚

ç›®å‰æ˜¯é  eng is None / eng is not None åˆ†æ”¯æ¥åŒºåˆ†ï¼Œè¿™ä¸ªé€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å‘½åä¸Šå®¹æ˜“è¯¯å¯¼ï¼ˆStockDaily çœ‹èµ·æ¥åƒ ORM å®ä½“ï¼Œå…¶å®åªæ˜¯ Plain classï¼‰ã€‚

ğŸ‘‰ å»ºè®®ï¼š

åœ¨ db/models.py é¡¶éƒ¨æ³¨æ˜ï¼šè¿™ä¸€ç‰ˆåªæ˜¯â€œæ•°æ®ç»“æ„ stubâ€ï¼Œä¸æ˜¯çœŸ ORM æ˜ å°„ï¼›

æˆ–è€…å¹²è„†å‘½åæˆ StockDailyRow, StockMinuteRowï¼Œé¿å…å°†æ¥ä½ å¼•å…¥ SQLAlchemy çœŸæ¨¡å‹æ—¶æ··æ·†ã€‚

2. æ•°æ®æº & Tick å­˜å‚¨ï¼ˆdata/base_source.py, pytdx_source.py, tick_store.pyï¼‰
2.1 DataSource / PytdxDataSource

è®¾è®¡ä¸Šå¾ˆ okï¼š

ç»Ÿä¸€äº† get_daily_bars / get_minute_bars / get_ticks æ¥å£ï¼›

è¿”å›å­—æ®µç»Ÿä¸€ï¼š["datetime", "open", "high", "low", "close", "volume", "amount"]ï¼Œtick å†é¢å¤–åŠ  price/side ç­‰ã€‚

å»ºè®®å‡ å¤„å°ä¼˜åŒ–ï¼š

Pytdx è¿æ¥é‡ç”¨ & é”™è¯¯å¤„ç†

ä½ å·²ç»åœ¨ __enter__ / __exit__ é‡Œåšäº† connect / disconnectï¼Œéå¸¸å¥½ï¼›

ä½†åœ¨ _autodetect_server é‡Œå¯¹æ¯ä¸ªå€™é€‰ IPï¼Œåªæ˜¯ç®€å• except Exception: passï¼Œå»ºè®®è‡³å°‘æ‰“å°ä¸€æ¡ debugï¼š

except Exception as e:
    print(f"[PytdxDataSource] connect failed {ip}:{port}, err={e}")


å°†æ¥å¦‚æœæœ‰â€œæŸå¤©çªç„¶è¿ä¸ä¸Šâ€ï¼Œä½ èƒ½ä»æ—¥å¿—é‡Œå¿«é€Ÿå®šä½ã€‚

get_ticks å­—æ®µæ ‡å‡†åŒ–

ä½ å·²ç»åšäº† buy/sell æ˜ å°„ã€å­—æ®µ renameï¼š

df = df.rename(columns={"vol": "volume"})
if "buyorsell" in df.columns:
    # 0=ä¹°, 1=å–


å»ºè®®å†å¤šç»Ÿä¸€ä¸¤ç‚¹ï¼š

ç»™ side è§„èŒƒæˆ "B" / "S" / "N"ï¼ˆä½ å·²ç»æœ‰è¿™ä¸ªé›å½¢ï¼‰ï¼Œå¹¶ä¿è¯ return df[cols] æ—¶ï¼Œcols çš„é¡ºåºå›ºå®šã€‚

tick æ•°æ®æœ€ç»ˆä¼šç”¨äºä½ çš„å¾®è§‚ç»“æ„åˆ†æï¼Œå¼ºçƒˆå»ºè®®åœ¨ docstring é‡Œå†™æ¸…æ¥šçº¦å®šå¥½çš„å­—æ®µå«ä¹‰ï¼ˆbid/ask ä»·æ˜¯å¦åŒ…å«ï¼Ÿæˆäº¤ä»·å­—æ®µå«ä»€ä¹ˆï¼Ÿï¼‰ã€‚

å¼‚å¸¸ä¸ä¸­æ–­æ•´ä¸ªå¾ªç¯

åé¢ updater.collect_intraday_ticks ä¸€æ¬¡ä¼šå¾ªç¯å¾ˆå¤š ts_codeï¼Œå½“å‰å†™æ³•ä¸€åªè‚¡ç¥¨å¼‚å¸¸ä¼šç›´æ¥æŠŠæ•´æ¬¡ä»»åŠ¡æ‰“æ–­ã€‚å»ºè®®åœ¨å•åªè‚¡ç¥¨å¤„ç†æ—¶å¥—ä¸€å±‚ try/exceptï¼š

for ts_code in ts_codes:
    try:
        df_tick = ds.get_ticks(...)
        ...
    except Exception as e:
        print(f"[collect_intraday_ticks] error ts={ts_code}, err={e}")
        continue

2.2 TickStore

TickStore è¿™å—æ•´ä½“è®¾è®¡æ˜¯å¯¹çš„ï¼š

åªæŠŠ tick å­˜åˆ°æ–‡ä»¶ï¼ˆparquetï¼‰ï¼Œä¸å…¥ DBï¼›

ç”¨ TickFileIndex è®°å½• meta ä¿¡æ¯ï¼ˆè·¯å¾„ + è¡Œæ•° + æ—¶é—´èŒƒå›´ï¼‰ã€‚

å»ºè®®ï¼š

Parquet å¢åŠ å‹ç¼© & engine æŒ‡å®š

ç›®å‰ç›´æ¥ï¼š

df.to_parquet(file_path)


å»ºè®®æ”¹æˆï¼š

df.to_parquet(file_path, engine="pyarrow", compression="snappy")


pyarrow+snappy åŸºæœ¬æ˜¯äº‹å®æ ‡å‡†ï¼›

åé¢æ•°æ®é‡ä¸Šæ¥ï¼Œèƒ½æ˜¾è‘—èŠ‚çœç£ç›˜ & IOã€‚

é¿å…æ¯æ¬¡ save_ticks éƒ½ sort

ä½ ç°åœ¨æ˜¯ä¿å­˜å‰ï¼š

dt_sorted = df.sort_values("datetime")


å¦‚æœä¸Šæ¸¸å·²ç»ä¿è¯ä¼ å…¥çš„ df æ˜¯æŒ‰æ—¶é—´æ’åºçš„ï¼Œè¿™ä¸€æ­¥å¯ä»¥ä½œä¸ºå¯é€‰ä¼˜åŒ–ï¼ˆä¾‹å¦‚é€šè¿‡ config æ§åˆ¶ï¼‰ï¼›

æˆ–è€…åœ¨ save_ticks å…¥å£å¤„æ·»åŠ ä¸€ä¸ªå‚æ•° already_sorted: bool = Falseï¼Œå…è®¸ä½ åœ¨é«˜é¢‘è°ƒç”¨é‡Œè·³è¿‡ sortã€‚

Index è¯»å†™å¯ä»¥å†å°ä¸€å±‚ API

ç›®å‰ TickStore åªè´Ÿè´£ä¿å­˜ parquet å’Œæ›´æ–°ç´¢å¼•ï¼Œè¯»å– tick æ—¶å®Œå…¨ä¸æŸ¥ç´¢å¼•ã€‚åé¢ä½ å¦‚æœè¦ï¼š

æŸ¥â€œæŸæ ‡çš„æœ€è¿‘ N æ—¥çš„ tick æ–‡ä»¶åˆ—è¡¨â€ï¼›

åšæ»šåŠ¨çª—å£è¯»å–ï¼›

å¯ä»¥åœ¨ TickStore æˆ–å•ç‹¬ TickIndexRepository é‡Œæ–°å¢æ–¹æ³•ï¼Œæ¯”å¦‚ï¼š

def list_tick_files(ts_code: str, start_date: date, end_date: date) -> List[TickFileIndex]:
    ...


è¿™ä¸ªä¼šéå¸¸åˆ©äºä½ åç»­åšç»„åˆå›æµ‹ / å¤šæ—¥å›æ”¾ã€‚

3. æ•°æ®æ›´æ–°é€»è¾‘ï¼ˆdata/updater.py, data/repository.py, data/jobs.pyï¼‰
3.1 updaterï¼šå¢é‡é€»è¾‘ OKï¼Œä½†éœ€è¦æ›´â€œæŠ—æ‰“æ–­â€

å½“å‰é€»è¾‘ï¼š

_get_all_stock_codes() â†’ ä½¿ç”¨ repository.get_all_stock_basics + STOCK_POOL_LIMIT æˆªæ–­ï¼Œåšå¾—å¾ˆå¥½ï¼›

update_daily_bars ç”¨â€œå–æœ€è¿‘ N æ¡ â†’ è¿‡æ»¤ trade_date > last_date â†’ upsertâ€ï¼›

update_minute_barsã€collect_intraday_ticks åŒæ ·æŒ‰ ts_code å¾ªç¯ã€‚

å»ºè®®ï¼š

ä¸ºæ¯ä¸€æ­¥åŠ æ›´ç»†ç²’åº¦çš„æ—¥å¿—

ä¾‹å¦‚ï¼š

print(f"[update_daily_bars] ts={ts_code}, last_date={last_date}, new_rows={len(df_new)}")


è¿™æ ·æ—¥åä½ ä¸€çœ‹æ—¥å¿—å°±èƒ½çŸ¥é“æ˜¯ä¸æ˜¯â€œçªç„¶å¾ˆå¤šè‚¡ç¥¨æ²¡æœ‰æ–°æ•°æ®â€ã€‚

é”™è¯¯éš”ç¦»ï¼Œé˜²æ­¢å•ç¥¨ç‚¸æ‰æ•´ä¸ª job

å‰é¢æè¿‡ï¼šå¯¹å•ä¸ª ts_code åš try/exceptï¼Œè®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­æ•´ä¸ªä»»åŠ¡ã€‚

å¯é€‰ï¼šåˆ†æ‰¹æ›´æ–° & å¤šè¿›ç¨‹

å½“ä½ çœŸçš„å¯¹å…¨ A è‚¡è·‘ daily/minute æ›´æ–°æ—¶ï¼š

ä¸€æ¬¡æ€§ä¸²è¡Œè·‘ 5000 åªä¼šæ¯”è¾ƒæ…¢ï¼›

å¯ä»¥è€ƒè™‘æŒ‰å—ï¼ˆæ¯”å¦‚æ¯æ¬¡ 200 åªï¼‰å¯åŠ¨å¤šè¿›ç¨‹ / å¤šçº¿ç¨‹ã€‚

è¿™å±äºæ€§èƒ½ä¼˜åŒ–çš„ä¸‹ä¸€é˜¶æ®µï¼Œç°åœ¨å¯ä»¥å…ˆä¸åšï¼Œä½†æ¶æ„ä¸Šå·²ç»é€‚åˆã€‚

3.2 repositoryï¼šDummy + Real ä¸¤ç§å®ç°æ··åˆ

è¿™ä¸ªæ–‡ä»¶ç°åœ¨åœ¨åšä¸€ä»¶ç•¥â€œé­”æœ¯â€çš„äº‹æƒ…ï¼š

eng is None â†’ ä½¿ç”¨ DummySession(), StockDaily/Minute çº¯ Python ç±»åš bulk_save_objectsï¼›

eng is not None â†’ ä½¿ç”¨ pandas.to_sql å†™å…¥çœŸå® Postgresã€‚

ä»æµ‹è¯•å’Œæ˜“ç”¨æ€§ä¸Šæ˜¯å¾ˆèªæ˜çš„è®¾è®¡ ğŸ‘ï¼Œä½†æˆ‘å»ºè®®ä½ åœ¨ä»£ç æ³¨é‡Šé‡Œå†æ˜ç¡®ä¸€ç‚¹ï¼š

StockDaily, StockMinute, StockBasic ä¸æ˜¯ ORM æ˜ å°„ï¼Œåªæ˜¯æ–¹ä¾¿ Dummy æ¨¡å¼ä¿å­˜æ•°æ®ç»“æ„ï¼›

çœŸæ­£çš„ç”Ÿäº§åº“å®Œå…¨æ˜¯ç”± to_sql + æ‰‹å†™ SQL ç®¡çš„ã€‚

å¦‚æœä»¥åä½ æ‰“ç®—æ¢æˆçœŸæ­£çš„ ORMï¼ˆSQLAlchemy Declarative Baseï¼‰ï¼š

è¿™ä¸ªæ–‡ä»¶å¯ä»¥åˆ†æˆ repository_dummy.py å’Œ repository_real.py ä¸¤ä¸ªå®ç°ï¼›

åœ¨ä¸€ä¸ªç»Ÿä¸€çš„ facade é‡Œé€šè¿‡ç¯å¢ƒå˜é‡åˆ‡æ¢å®ç°ã€‚

3.3 jobsï¼šå…¥å£è¶³å¤Ÿç®€å•ï¼Œä½†å¯ä»¥åŠ ä¸€ä¸ª CLI

ç°åœ¨ data/jobs.py åªæ˜¯ä¸€ä¸ªæ¨¡å—çº§å‡½æ•°é›†åˆï¼š

job_update_ohlc(trade_date)

job_collect_intraday_ticks(trade_date)

å»ºè®®åç»­åŠ ä¸¤ä¸ªå°è„šæœ¬ï¼ˆä½ å°†æ¥å¯èƒ½å·²ç»å†™äº†ï¼‰ï¼š

cli/run_update_ohlc.py

cli/run_collect_ticks.py

è¿™æ ·ä½ åœ¨ crontab é‡Œå°±å¯ä»¥ç›´æ¥ï¼š

python -m cli.run_update_ohlc --date 2025-11-13


æ¯” python -m data.jobs æ›´æ˜æ˜¾ä¹Ÿæ›´å®‰å…¨ã€‚

4. ç­–ç•¥å±‚æŠ½è±¡ï¼ˆstrategy/base.py, strategy/registry.pyï¼‰

è™½ç„¶ zip é‡Œæš‚æ—¶åªæœ‰æŠ½è±¡å’Œ Dummy å®ç°ï¼Œä½†ä»æ¶æ„ä¸Šæ˜¯ç»™è‡ªå·±ç•™äº†ä¸€ä¸ªå¾ˆèˆ’æœçš„â€œæ’åº§â€ï¼š

Bar, Tick, PriceLevel, MicrostructureFeatures, TradeSignal ç”¨ dataclass å®šä¹‰ï¼›

StrategyContext ç”¨ Protocol çº¦æŸäº†æœ€æ ¸å¿ƒçš„æ¥å£ï¼š

get_position(ts_code)

get_cash()

log(msg)

get_config()

PriceLevelProvider, MicrostructureProvider, BaseStrategy éƒ½æ˜¯ ABCã€‚

å»ºè®®ï¼šæå‰ä¸ºâ€œé˜¿å¸ƒå…³é”®ä½ç­–ç•¥â€é¢„ç•™ç»Ÿä¸€æ¥å£

å³ä¾¿ä½ ç°åœ¨ GitHub ä¸Šå·²ç»æœ‰äº†é˜¿å¸ƒä»·æ ¼ç†è®ºçš„å…·ä½“å®ç°ï¼Œè¿™é‡Œä»ç„¶æœ‰å‡ ä¸ªç»Ÿä¸€ç‚¹å¯ä»¥è€ƒè™‘ï¼š

è®© Abu ç­–ç•¥ä¹Ÿå®ç° BaseStrategy

on_tick / on_bar è¿”å› List[TradeSignal]ï¼›

â€œä¸‹å•æ‰§è¡Œâ€ç”± BacktestEngine / LiveEngine æ¥å¤„ç†ï¼Œä¸åœ¨ç­–ç•¥å†…éƒ¨ç›´æ¥ ctx.send_orderã€‚

å¥½å¤„ï¼š

ä»¥åä½ è¦æ›¿æ¢ç­–ç•¥ï¼Œåªè¦æ¢æ‰ BaseStrategy å®ç°ï¼›

Portfolio å±‚ï¼ˆç»„åˆå›æµ‹ / å®ç›˜è°ƒåº¦ï¼‰å¯ä»¥å®Œå…¨ä¸å…³å¿ƒç­–ç•¥ç»†èŠ‚ã€‚

Registry çš„æ˜ å°„è¡¨ç”¨å¸¸é‡+æ³¨é‡Šå†™æ¸…

strategy/registry.py é‡Œä½ å·²ç»æœ‰ç±»ä¼¼ï¼š

_REGISTRY = {
    "dummy": (DummyStrategy, DummyPriceLevelProvider, DummyMicrostructureProvider),
    # "abu_key_level": (AbuKeyLevelStrategy, AbuPriceLevelProvider, AbuMicrostructureAnalyzer),
}


å»ºè®®æ—¥åæŠŠé˜¿å¸ƒç­–ç•¥çš„é‚£è¡ŒçœŸæ­£å†™ä¸Šï¼ŒåŒæ—¶åœ¨æ³¨é‡Šé‡Œå†™æ˜å®ƒçš„çº¦æŸï¼ˆä¾‹å¦‚éœ€è¦ tick çº§åˆ«æ•°æ®ã€ä¾èµ–çš„å­—æ®µç­‰ï¼‰ã€‚

5. æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼šæ—¥å¿—ã€æµ‹è¯•ã€æ€§èƒ½
5.1 æ—¥å¿—ï¼šä» print é€æ­¥æ¢æˆ logging

ç°åœ¨å‡ ä¹æ‰€æœ‰æ¨¡å—éƒ½ç›´æ¥ printï¼š

å¯¹å¼€å‘é˜¶æ®µéå¸¸å‹å¥½ï¼›

ä½†ä¸€æ—¦ä½ å¼€å§‹åœ¨æœåŠ¡å™¨é•¿æœŸè·‘å®šæ—¶ä»»åŠ¡ï¼Œä¼šå˜å¾—éš¾ä»¥æ§åˆ¶ï¼ˆæ— æ³•æŒ‰æ¨¡å—è¿‡æ»¤ã€æ— æ³•åˆ†çº§ï¼‰ã€‚

æ¨èä¸€ä¸ªå¾ªåºæ¸è¿›çš„æ›¿æ¢ï¼š

åœ¨ config.py é‡Œå†™ä¸€ä¸ªç®€å•çš„ logger å·¥å‚ï¼š

import logging

def get_logger(name: str = "quant"):
    logger = logging.getLogger(name)
    if not logger.handlers:
        handler = logging.StreamHandler()
        fmt = logging.Formatter("[%(asctime)s][%(levelname)s][%(name)s] %(message)s")
        handler.setFormatter(fmt)
        logger.addHandler(handler)
        logger.setLevel(logging.INFO)
    return logger


åœ¨æ ¸å¿ƒæ¨¡å—é‡Œç”¨ï¼š

from config import get_logger
logger = get_logger(__name__)
logger.info("...")
logger.error("...", exc_info=True)


å…ˆåªæ”¹å…³é”®è·¯å¾„ï¼ˆupdater, pytdx_source, jobsï¼‰ï¼Œå…¶ä½™åœ°æ–¹æ…¢æ…¢æ¢ã€‚

5.2 æµ‹è¯•ï¼šæŠŠ __main__ è‡ªæµ‹å‡çº§ä¸º pytest

ä½ ç°åœ¨çš„è‡ªæµ‹æ¨¡å¼æ˜¯ï¼š

if __name__ == "__main__":
    # æ„é€ ä¸€ä¸ª dummy è¾“å…¥ï¼Œè·‘ä¸€éå‡½æ•°


å®Œå…¨ okï¼Œä½†å»ºè®®åé¢ï¼š

åœ¨é¡¹ç›®æ ¹åŠ ä¸€ä¸ª tests/ ç›®å½•ï¼›

æŠŠè¿™äº› self-test é€»è¾‘è½¬æˆ pytest ç”¨ä¾‹ï¼Œæ¯”å¦‚ï¼š

def test_tick_store_roundtrip(tmp_path):
    store = TickStore(base_dir=tmp_path)
    ...


å¥½å¤„ï¼š

ä½ å¯ä»¥åœ¨æœ¬åœ° / CI ç”¨ pytest ä¸€æ¬¡æ€§è·‘æ‰€æœ‰æµ‹è¯•ï¼›

å°†æ¥æ”¹åŠ¨åº•å±‚å®ç°ï¼ˆæ¯”å¦‚ tick å­˜å‚¨è·¯å¾„ç»“æ„ï¼‰æ—¶ï¼Œæœ‰å›å½’ä¿éšœã€‚

5.3 æ€§èƒ½ï¼šç›®å‰è¶³å¤Ÿç”¨ï¼Œä½†æœªæ¥éœ€è¦è§„åˆ’

çŸ­æœŸå†…ï¼Œä½ è¿˜åœ¨â€œéªŒè¯ç­–ç•¥ + æ‰“é€šé“¾è·¯â€é˜¶æ®µï¼Œç°æœ‰å®ç°å®Œå…¨å¤Ÿç”¨ã€‚
ä½†ç­‰åˆ°ï¼š

è‚¡ç¥¨æ± æ‰©åˆ°å…¨ Aï¼ˆä¸Šåƒåªï¼‰ï¼›

åˆ†é’Ÿ + tick æ•°æ®æŒç»­ç§¯ç´¯ï¼›

å»ºè®®é‡ç‚¹å…³æ³¨ï¼š

Pytdx è¯·æ±‚èŠ‚æµ & å¹¶å‘ç­–ç•¥

Tick æ–‡ä»¶æ•°é‡ & ç›®å½•ç»“æ„

ç°åœ¨æ˜¯ base_dir / MARKET / CODE / date.parquetï¼Œç»“æ„å·²ç»å¾ˆåˆç†ï¼›

å°†æ¥å¯ä»¥åœ¨ CODE ä¸‹æŒ‰ç…§å¹´ä»½å†å»ºä¸€å±‚ç›®å½•ï¼Œé¿å…å•ç›®å½•ä¸‹æ–‡ä»¶æ•°è¿‡å¤šã€‚

æ•°æ®åº“ç´¢å¼•

å¯¹ stock_daily / stock_minute ä¸ŠåŠ  (ts_code, trade_date) ç´¢å¼•ï¼›

å¯ä»¥æ˜¾è‘—åŠ é€Ÿå¢é‡æ›´æ–°ä¸­çš„ delete / select max(trade_date)ã€‚