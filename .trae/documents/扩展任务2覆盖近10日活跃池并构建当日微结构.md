## 目标
- 将 `build_microstructure_daily` 的股票集合从“当日活跃池”扩展为“最近10个交易日内进入活跃池的并集”，在 `trade_date` 当天计算并写入 `stock_microstructure_daily`。
- 仍保持：仅处理当日确有 tick 的股票；阈值 `q` 按自由流通市值分组；写库前清理当日旧记录。

## 现状
- 代码位置：`d:\quant\data\jobs.py:389` 定义 `build_microstructure_daily`。
- 当前集合来源：当日 `stock_active_pool`（或全市场），并过滤当日 `tick_file_index(record_cnt>0)`（`d:\quant\data\jobs.py:393–414`）。
- 需求差异：需要将集合改为“`trade_date` 向前回看10个交易日内的 `stock_active_pool` 并集”。

## 技术方案
1. 函数签名调整
- 修改为：`def build_microstructure_daily(trade_date: _date, lookback_days: int = 10, only_active_pool: bool = True, q: float = 0.9)`。

2. 交易日集合获取
- 通过 `trading_calendar` 表获取最近 `lookback_days` 个交易日（避免自然日偏差）。
- 记为 `dates_10 = last_n_trading_days(trade_date, n=lookback_days)`。

3. 股票集合构建（仅活跃池模式）
- 查询：`select ts_code from stock_active_pool where trade_date = any(:dates_10)`，去重得到 `ts_list`。
- 非活跃池模式保持原逻辑：`get_all_stock_basics()`。

4. 当日 tick 覆盖过滤
- 仅保留当日确有 tick 的代码：
  - 查询 `tick_file_index`：`select ts_code, record_cnt from tick_file_index where trade_date=:d`；
  - 过滤条件：`record_cnt > 0`。

5. 分位数 `q` 的市值分组（若存在自由流通列）
- 保持现有列探测：`free_float_value/free_float_mv/float_mv/free_float_market_cap`。
- 分配：低/中/高对应 `0.9/0.95/0.97`。

6. 当日微结构计算
- 遍历 `ts_list` 按 `q_map` 选取 `q_use`，调用：`summarize_microstructure_for_stock(ts_code, trade_date, q_use)`。
- 指标含义与口径保持不变（大单分位数阈值、分时段净额、订单流不平衡等）。

7. 写库与幂等
- 在事务内：
  - 若表存在，先 `delete from stock_microstructure_daily where trade_date=:d`。
  - 追加 `to_sql('stock_microstructure_daily', if_exists='append')`。
- 进度条保持。

## 验证与观测
- 数量一致性：
  - 近10日活跃池并集与当日 tick 覆盖的交集行数 ≈ 当日插入行数。
  - SQL：
    - 并集：`select count(distinct ts_code) from stock_active_pool where trade_date = any(:dates_10)`；
    - tick 过滤：`select count(distinct ts_code) from tick_file_index where trade_date=:d and record_cnt>0`；
    - 插入：`select count(*) from stock_microstructure_daily where trade_date=:d`。
- 指标非零率：抽样检查 `big_net_ratio`、`big_net_close`、`order_flow_imbalance` 非零分布。
- 幂等性：重复执行同一日不会产生重复行（因“先删后写”）。

## 兼容与约束
- 全流程用 Pandas + SQLAlchemy，避免 Python `for` 的数据遍历（保留当前向量化口径）。
- 不使用 `try-except`；分支通过条件控制。
- 仅在当日维度计算与写库；不跨日写入，确保任务职责单一。

## 变更影响
- 调整了股票集合定义；计算与写库路径保持不变。
- 资源占用增加（集合更大），但仍受 `tick` 覆盖过滤；建议在日志打印集合规模与插入行数。

## 实施步骤
1. 更新函数签名与集合构建（包含交易日列表查询与并集去重）。
2. 维持 tick 过滤、`q_map`、计算与写库逻辑。
3. 增加日志：`lookback_days`、`episodes_union_size`、`post_tick_filter_size`、`inserted_rows`。
4. 在菜单项 2 增加 `lookback_days` 输入（默认 10）。

## 测试用例（以 2025-04-18）
- 执行：菜单 2 → 输入 `2025-04-18`、仅活跃池 `Y`、`q=0.9`、`lookback_days=10`。
- 预期：插入行数 ≈ 近10日活跃池并集与当日 `tick` 覆盖的交集。示例：若 4/17=62、4/18=57，并集去重≈119；若当日 tick 覆盖略少，插入行数略低。
- SQL 验证：上述数量一致性与指标抽样。

## 后续（任务6）
- 资金质量任务同样可在“当前日”对近10日活跃池并集逐股计算窗口并写库（当日 `window_end=trade_date`），实现“当前日快照覆盖近10日活跃池”。是否一并按相同模式扩展任务6？