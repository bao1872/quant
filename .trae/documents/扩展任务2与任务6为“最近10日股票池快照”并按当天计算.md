## 任务1（构建股性活跃池）逻辑梳理

### 输入与数据源

* 输入：`trade_date`

* 源表：`stock_bollinger_data`（价格/量布林位）、`stock_daily`（成交额）

* 行为：依据当日布林位与近窗成交额筛选事件日活跃股票

### 步骤

* 读取当日布林位（价格/量）用于事件日筛选：`d:\quant\data\jobs.py:170–174`

* 事件日同日量价齐升判断：`v_price_position>99` 且 `price_position>ppos_threshold`：`d:\quant\data\jobs.py:182–184`

* 近窗成交额均值计算：窗口 `window_days` 内 `stock_daily.amount` 分组平均：`d:\quant\data\jobs.py:186–195`

* 前20日约束：不得出现同日 `price_position>99`（只看价格布林）：`d:\quant\data\jobs.py:198–211`

* 综合过滤：`has_both` ∧ `(~prev_ppos)` ∧ `avg_amount>min_avg_amount`：`d:\quant\data\jobs.py:209–211`

* 写库前清理当日旧记录，再插入当日候选：`d:\quant\data\jobs.py:228–234`

### 输出

* 表：`stock_active_pool`

* 列：`ts_code/trade_date/window_days/has_high_vpos/has_high_ppos/max_vpos/max_ppos/avg_amount/remarks`：`d:\quant\data\jobs.py:225–233`

### 设计要点

* 使用 `_table_columns` 动态确定 `stock_bollinger_data` 的日期列名（`trade_date`/`date`）：`d:\quant\data\jobs.py:165–168`

* 只依赖真实数据库，不做本地大规模重算；增量逻辑（当日清理+插入）

* 全流程向量化（pandas 分组/筛选/合并），不使用 `for` 循环

## 扩展实现计划：任务2/任务6覆盖最近10个交易日股票池

### 目标

* 任务2（构建日度微结构摘要）与任务6（构建资金质量）都在“当前 `trade_date`”对“最近10个交易日的活跃池并集”进行计算；保证当天指标覆盖近10日入池股票。

### 任务2（微结构）改造要点

* 取近10日活跃池并集：从 `trade_date-9` 至 `trade_date` 查询 `stock_active_pool` 的 `ts_code` 集合

* 仅处理有当日 tick 的股票（`tick_file_index.record_cnt>0`），避免全 0：沿用现有过滤

* 保持分位数阈值与分时段窗口逻辑不变

* 写库：清理当日旧记录后插入；不改变列结构

### 任务6（资金质量）改造要点

* 同步使用近10日活跃池并集作为当天待计算集合

* 窗口起点沿用“最近20日收盘最低点”的确定方法：`detect_window_by_min_close`

* 指标计算沿用现有逻辑（`price_return/big_net_sum/turnover_ratio/...`）

* 写库：清理 `window_end=trade_date` 的旧记录后插入

### 校验与验证

* 任务2验证：

  * `select count(*) from stock_microstructure_daily where trade_date=:d` 应≈近10日并集（扣除无 tick 者）

  * 抽样大单相关列非 0：`big_net_ratio/order_flow_imbalance`

* 任务6验证：

  * `select count(*) from stock_fund_quality where window_end=:d` 应≈近10日并集

  * 抽样检查 `turnover_ratio/big_net_to_float_ratio` 非 0（回退逻辑与自由流通列命中）

### 风险与处理

* 自由流通列名差异：保持候选列匹配与 0 分母回退

* tick 缺失：限 `record_cnt>0`，避免产生无意义记录

* 性能：查询并集 + 向量化计算；必要时批量分组运行

### 下一步

* 我将按上述计划改造任务2与任务6的取数范围为“最近10日活跃池并集”，并添加必要的验证查询；完成后与你确认指标覆盖与行数符合预期。

