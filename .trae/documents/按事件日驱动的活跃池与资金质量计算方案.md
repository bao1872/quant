## 改造目标

* 将活跃池记录从“窗口内曾经满足”改为“事件日满足”，准确标注满足 `v_price_position` 与 `price_position` 阈值的具体日期（事件日）。

* 阶段2的资金质量以事件日为窗口终点，向前回看一段时间评估资金质量，并支持后续“资金质量高 vs 低 的未来收益分布”统计。

## 表结构与约定

* `stock_active_pool`

  * 现有含 `ts_code、trade_date、window_days、has_high_vpos、has_high_ppos、max_vpos、max_ppos、avg_amount、remarks`。

  * 约定调整：`trade_date` 表示“事件日”（即当日满足量价阈值的日期）。无需新增文件；语义改为事件日。

  * 主键约定保持 `(ts_code, trade_date)`。

## 任务1：活跃池事件日化

* 读取当日 `stock_bollinger_data`：只取当日 `ts_code、v_price_position、price_position`。

* 条件判定：`cond_both = (v_price_position>99) & (price_position>ppos_threshold)`（同日量价齐升）。

* 读取回看窗口的 `stock_daily`（`[trade_date - (window_days-1), trade_date]`）计算 `avg_amount`。

* 输出：为所有 `cond_both=True` 的股票写入一行，`trade_date=事件日`（当日）、`window_days=回看窗口`、`has_high_vpos=True`、`has_high_ppos=True`、`max_vpos/max_ppos=当日值`、`avg_amount=窗口均值`。

* 删除当日旧记录后 `append` 新记录，保证增量与原子性。

## 任务2：以事件日为终点的资金质量（阶段2）

* 选股范围：当日事件日活跃池（`stock_active_pool.trade_date == d`）。

* 上涨窗口识别（事件日驱动）：

  * 输入：`ts_code、event_date`。

  * 读取最近 `max_lookback` 天 `stock_daily.close`，以 `event_date` 为窗口终点，识别满足“收益>0且最大回撤不超过阈值”的最早起点；否则回退到近 5 天。输出 `[window_start, event_date, window_days]`。

* 资金质量计算：在 `[window_start, event_date]` 上，读取 `stock_microstructure_daily + stock_daily`，计算：

  * `price_return、big_net_sum、turnover_ratio、pos_days_ratio、trend_corr、support_ratio、big_cost_gain(暂置NaN)`；

  * 简版综合分数 `fund_quality_score`（加权和）。

* 写库：删除 `window_end=event_date` 的旧记录后追加写入 `stock_fund_quality`（不做结构迁移，`to_sql` 自动建表）。

## 未来收益分布统计（阶段2扩展）

* 以 `stock_fund_quality` 当日（事件日）分数，将标的分为高/低两组（如前30% vs 后30%）。

* 读取 `stock_daily.close` 的未来收益（如 `T+5、T+20`），计算两组的收益分布（均值、中位数、分位数），输出到统计表或日志。

## 参数与默认值

* `ppos_threshold` 默认 `50.0`（可交互输入）。

* `window_days` 默认 `20`，用于 `avg_amount` 回看窗口。

* 资金质量 `max_lookback` 默认 `20`，`max_drawdown` 默认 `0.06`。

## 验证与观测

* 事件日活跃池：

  * 当日插入行数、`max_vpos/max_ppos` 与 `avg_amount` 的合理性（分位数打印）。

* 资金质量：

  * 插入行数与各指标的缺失/0值比例统计；特别是 `turnover_ratio`（若缺“自由流通市值”列则为0）与 `big_cost_gain`（暂置NaN）。

* 未来收益分布：

  * 输出高 vs 低分组的未来收益分布摘要（均值/分位数），辅助参数校准。

## 实现细节（不修改文件名）

* `d:\quant\data\jobs.py`

  * 修改 `build_active_pool`：按当日同日量价齐升筛选，并以当日为事件日写库；`avg_amount` 使用最近窗口均值；移除跨日 `has_both in window` 的入选逻辑。

  * 修改 `build_fund_quality`：以事件日活跃池驱动，窗口终点使用 `trade_date`（事件日）。

  * 保持向量化与 `pandas` + SQL；无 `try-except`；事务写入。

## 风险与兼容

* 表语义调整为“事件日”，无需迁移字段；前端或后续任务若使用该表需以“事件日”解释。

* 若需保留“近一段时间的候选集合”视角，可在查询时按事件日范围过滤。

## 预计影响范围

* 活跃池入选数量会减少为“当日事件满足集合”，更精准；资金质量窗口终点改为事件日，与策略逻辑更一致。

## 下一步

* 按此计划更新 `build_active_pool` 与 `build_fund_quality` 的行为。

* 增加简单统计函数输出“资金质量高 vs 低 的未来收益分布”以验证实用性。

